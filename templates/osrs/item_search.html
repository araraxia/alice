<div class="window-content" id="item-search-window">
  <div class="title-bar" id="item-search-title-bar">
    <h4>Item Search</h4>
    <div>
      <button id="close-item-search-button" class="w98-button title-button">
        X
      </button>
    </div>
  </div>

  <div style="padding: 20px">
    <div style="margin-bottom: 20px">
      <label style="display: block; margin-bottom: 5px">Search By:</label>
      <select
        id="search-type-select"
        class="w98-input"
        style="width: 100%; padding: 5px; margin-bottom: 10px"
      >
        <option value="name">Item Name</option>
        <option value="id">Item ID</option>
      </select>

      <input
        type="text"
        id="search-input"
        class="w98-input"
        placeholder="Enter item name or ID"
        style="width: calc(100% - 12px); padding: 5px; margin-bottom: 10px"
      />

      <button
        id="search-button"
        class="w98-button"
        style="width: 100%; padding: 8px"
      >
        Search
      </button>
    </div>

    <div
      id="search-results"
      style="
        max-height: 400px;
        overflow-y: auto;
        border: 1px solid #000;
        padding: 10px;
        background-color: white;
      "
    >
      <p style="color: #666; text-align: center">
        Enter a search query to find items
      </p>
    </div>
  </div>

  <script>
    (function () {
      const searchInput = document.getElementById("search-input");
      const searchButton = document.getElementById("search-button");
      const searchTypeSelect = document.getElementById("search-type-select");
      const searchResults = document.getElementById("search-results");

      function performSearch() {
        const searchType = searchTypeSelect.value;
        const searchValue = searchInput.value.trim();

        if (!searchValue) {
          searchResults.innerHTML =
            '<p style="color: #666; text-align: center;">Please enter a search query</p>';
          return;
        }

        searchResults.innerHTML =
          '<p style="color: #666; text-align: center;">Searching...</p>';

        // Get CSRF token from meta tag
        const csrfToken = document
          .querySelector('meta[name="csrf-token"]')
          ?.getAttribute("content");

        const headers = {
          "Content-Type": "application/json",
        };

        // Add CSRF token if available
        if (csrfToken) {
          headers["X-CSRFToken"] = csrfToken;
        }

        fetch("/osrs/item-search/search", {
          method: "POST",
          headers: headers,
          body: JSON.stringify({
            search_type: searchType,
            search_value: searchValue,
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.status === "success") {
              displayResults(data.items);
            } else {
              searchResults.innerHTML = `<p style="color: red; text-align: center;">Error: ${data.message}</p>`;
            }
          })
          .catch((error) => {
            console.error("Search error:", error);
            searchResults.innerHTML =
              '<p style="color: red; text-align: center;">An error occurred during search</p>';
          });
      }

      function displayResults(items) {
        if (!items || items.length === 0) {
          searchResults.innerHTML =
            '<p style="color: #666; text-align: center;">No items found</p>';
          return;
        }

        let html =
          '<div style="display: flex; flex-direction: column; gap: 10px;">';

        items.forEach((item) => {
          html += `
                        <div style="border: 1px solid #ccc; padding: 10px; background-color: #f9f9f9;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <strong style="font-size: 14px;">${escapeHtml(item.name)}</strong>
                                <span style="color: #666; font-size: 12px;">ID: ${item.id}</span>
                            </div>
                            ${item.examine ? `<p style="margin: 5px 0; font-size: 12px; color: #555;">${escapeHtml(item.examine)}</p>` : ""}
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px; font-size: 11px; margin-top: 8px;">
                                ${item.value !== null ? `<div><strong>Value:</strong> ${item.value.toLocaleString()} gp</div>` : ""}
                                ${item.highalch !== null ? `<div><strong>High Alch:</strong> ${item.highalch.toLocaleString()} gp</div>` : ""}
                                ${item.lowalch !== null ? `<div><strong>Low Alch:</strong> ${item.lowalch.toLocaleString()} gp</div>` : ""}
                                ${item.limit !== null ? `<div><strong>GE Limit:</strong> ${item.limit.toLocaleString()}</div>` : ""}
                                <div><strong>Members:</strong> ${item.members ? "Yes" : "No"}</div>
                            </div>
                            <div style="margin-top: 10px;">
                                <button 
                                    class="w98-button"
                                    id="price-data-button-${item.id}"
                                    onclick="openPriceDataWindow(${item.id}, '${escapeHtml(item.name).replace(/'/g, "\\'")}')"
                                    style="width: 100%; padding: 6px; font-size: 12px;"
                                >
                                    Price Data
                                </button>
                            </div>
                        </div>
                    `;

          // Create window initializer for this item's price data selector
          const windowHtml = `
            <div class="window-content" id="price-data-selector-container-${item.id}" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 400px; z-index: 10001; background: white; border: 2px solid #000; box-shadow: 4px 4px 0 rgba(0,0,0,0.2);">
              <div class="title-bar" id="price-data-selector-title-bar-${item.id}" style="background: linear-gradient(to bottom, #000080, #1084d0); color: white; padding: 4px 8px; display: flex; justify-content: space-between; align-items: center; cursor: move;">
                <h4 style="margin: 0; font-size: 14px;">Price Data - ${escapeHtml(item.name)}</h4>
                <button class="w98-button" id="price-data-selector-close-button-${item.id}" style="padding: 2px 8px; font-size: 12px;">X</button>
              </div>
              <div style="padding: 20px;">
                <h3 style="margin-top: 0; font-size: 16px;">Select Time Range</h3>
                <div style="display: flex; flex-direction: column; gap: 10px;">
                  <button class="w98-button" onclick="loadPriceGraph(${item.id}, '${escapeHtml(item.name).replace(/'/g, "\\'")}', '12h')" style="padding: 10px; width: 100%;">
                    Last 12 Hours
                  </button>
                  <button class="w98-button" onclick="loadPriceGraph(${item.id}, '${escapeHtml(item.name).replace(/'/g, "\\'")}', '1d')" style="padding: 10px; width: 100%;">
                    Last 1 Day
                  </button>
                  <button class="w98-button" onclick="loadPriceGraph(${item.id}, '${escapeHtml(item.name).replace(/'/g, "\\'")}', '7d')" style="padding: 10px; width: 100%;">
                    Last 7 Days
                  </button>
                  <button class="w98-button" onclick="loadPriceGraph(${item.id}, '${escapeHtml(item.name).replace(/'/g, "\\'")}', '1m')" style="padding: 10px; width: 100%;">
                    Last 1 Month
                  </button>
                </div>
                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #ccc;">
                  <label style="display: block; margin-bottom: 5px; font-size: 12px;">Data Type:</label>
                  <select id="table-type-${item.id}" class="w98-input" style="width: 100%; padding: 5px;">
                    <option value="5min">5-Minute Average</option>
                    <option value="1h">1-Hour Average</option>
                    <option value="latest">Latest (Real-time)</option>
                  </select>
                </div>
              </div>
            </div>
          `;

          console.log(`[item_search.html] Creating WindowInitializer instance for item: ${item.id} - ${item.name}`);
          new window.WindowInitializer(
            window.windowManager,
            `priceDataSelector${item.id}`,
            `price-data-selector-window-${item.id}`,
            `price-data-selector-container-${item.id}`,
            `price-data-button-${item.id}`,
            `price-data-selector-title-bar-${item.id}`,
            `price-data-selector-close-button-${item.id}`,
            windowHtml,
            true
          );
          const priceButton = document.getElementById(`price-data-button-${item.id}`);
          if (priceButton) {
            priceButton.addEventListener("click", async function () {
              console.log(`[item_search.html] Price Data button clicked for item: ${item.id} - ${item.name}`);
              try {
                await window[`priceDataSelector${item.id}Instance`].open();
              } catch (error) {
                console.error('Error opening price data selector:', error);
              }
            });
          } else {
            console.warn(`[item_search.html] Price Data button not found for item: ${item.id} - ${item.name}`);
          }
        });

        html += "</div>";
        searchResults.innerHTML = html;
      }

      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      searchButton.addEventListener("click", performSearch);
      searchInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          performSearch();
        }
      });

      // Update placeholder text based on search type
      searchTypeSelect.addEventListener("change", () => {
        const searchType = searchTypeSelect.value;
        searchInput.placeholder =
          searchType === "id" ? "Enter item ID" : "Enter item name";
        searchInput.value = "";
        searchResults.innerHTML =
          '<p style="color: #666; text-align: center;">Enter a search query to find items</p>';
      });

      // Make openPriceDataWindow globally accessible
      window.openPriceDataWindow = async function (itemId, itemName) {
        // Create time range selector window
        console.log('[item_search.html] Opening price data selector for item:', itemId, itemName);
        try {
          const instanceName = `priceDataSelector${itemId}Instance`;
          const instance = window[instanceName];
          if (instance) {
            await instance.open();
          } else {
            console.error(`Price data selector instance not found: ${instanceName}`);
          }
        } catch (error) {
          console.error('Error opening price data selector:', error);
        }
      };

      window.closePriceDataSelector = function(itemId) {
        const instanceName = `priceDataSelector${itemId}Instance`;
        const instance = window[instanceName];
        if (instance && typeof instance.close === 'function') {
          instance.close();
        }
      };

      window.loadPriceGraph = function (itemId, itemName, timeRange) {
        // Calculate start date based on time range
        const now = new Date();
        const startDate = new Date(now);

        switch (timeRange) {
          case "12h":
            startDate.setHours(now.getHours() - 12);
            break;
          case "1d":
            startDate.setDate(now.getDate() - 1);
            break;
          case "7d":
            startDate.setDate(now.getDate() - 7);
            break;
          case "1m":
            startDate.setMonth(now.getMonth() - 1);
            break;
        }

        const tableType =
          document.getElementById(`table-type-${itemId}`)?.value || "5min";

        // Get CSRF token
        const csrfToken = document
          .querySelector('meta[name="csrf-token"]')
          ?.getAttribute("content");
        const headers = {
          "Content-Type": "application/json",
        };
        if (csrfToken) {
          headers["X-CSRFToken"] = csrfToken;
        }

        // Show loading message
        const selector = document.getElementById(
          `price-data-selector-${itemId}`,
        );
        if (selector) {
          const content = selector.querySelector('div[style*="padding: 20px"]');
          content.innerHTML =
            '<p style="text-align: center; padding: 20px;">Loading price data...</p>';
        }

        // Fetch price graph
        fetch("/osrs/item-price-graph", {
          method: "POST",
          headers: headers,
          body: JSON.stringify({
            item_id: itemId,
            start_date: startDate.toISOString(),
            end_date: now.toISOString(),
            table_type: tableType,
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.status === "success") {
              // Close the selector
              closePriceDataSelector(itemId);
              // Inject the price graph modal
              document.body.insertAdjacentHTML("beforeend", data.html);
            } else {
              if (selector) {
                const content = selector.querySelector(
                  'div[style*="padding: 20px"]',
                );
                content.innerHTML = `<p style="color: red; text-align: center;">Error: ${data.message}</p>`;
              }
            }
          })
          .catch((error) => {
            console.error("Error loading price graph:", error);
            if (selector) {
              const content = selector.querySelector(
                'div[style*="padding: 20px"]',
              );
              content.innerHTML =
                '<p style="color: red; text-align: center;">An error occurred while loading the graph</p>';
            }
          });
      };

      // Simple draggable functionality
      function makeDraggable(element, handle) {
        let pos1 = 0,
          pos2 = 0,
          pos3 = 0,
          pos4 = 0;

        handle.onmousedown = dragMouseDown;

        function dragMouseDown(e) {
          e.preventDefault();
          pos3 = e.clientX;
          pos4 = e.clientY;
          document.onmouseup = closeDragElement;
          document.onmousemove = elementDrag;
        }

        function elementDrag(e) {
          e.preventDefault();
          pos1 = pos3 - e.clientX;
          pos2 = pos4 - e.clientY;
          pos3 = e.clientX;
          pos4 = e.clientY;
          element.style.top = element.offsetTop - pos2 + "px";
          element.style.left = element.offsetLeft - pos1 + "px";
        }

        function closeDragElement() {
          document.onmouseup = null;
          document.onmousemove = null;
        }
      }
    })();
  </script>
</div>
