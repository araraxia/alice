<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="csrf-token" content="{{ csrf_token() }}" />
    <title>Araxia.xyz</title>
    <style>
      body {
        margin: 0;
        padding: 0;
        font-family: Arial, sans-serif;
        visibility: hidden;
        min-height: 100vh;
      }
    </style>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/main.css') }}"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/index.css') }}"
    />
  </head>
  <body>
    <canvas id="background"></canvas>
    <div
      id="index_container"
      class="draggable-window medium-window index_container"
    >
      <div class="window-content">
        <div class="title-bar" id="index-title-bar">
          <h4>Araxia.xyz</h4>
          <div>
            <button
              id="bg-control-button"
              class="w98-button title-button"
              title="Background Control"
            >
              BG
            </button>
            <button id="help-me-button" class="w98-button title-button">
              ?
            </button>
          </div>
        </div>
        <h1>Welcome!</h1>
        <ul>
          <li>
            <p>
              This is a personal site built and hosted by Aria Corona to showcase neat things and act as a digital playground to experiment and learn new things.
            </p>
          </li>
          <li>
            <div class="index-window-navbuttons">
              <button class="w98-button" id="osrs-index-button">
                OSRS Tools
              </button>
              <button class="w98-button" id="showcase-button">
                Showcase
              </button>
              <button class="w98-button" id="blog-button" disabled=true>Blog</button>
              <button class="w98-button" id="about-me-button" disabled=true>Bio</button>
              <a href="https://github.com/araraxia">
                <button class="w98-button" id="github-button">
                  Github
                </button>
              </a> 
            </div>
          </li>
            {% if current_user.is_authenticated %}
            <div
              class="log-reg-container"
              style="
                display: flex;
                flex-direction: row;
                align-items: center;
                gap: 10px;
                justify-content: center;
              "
            >
              <p style="margin: 0">
                Logged in as: <strong>{{ current_user.username }}</strong>
              </p>
              <button class="w98-button" id="index-logout-btn">Logout</button>
            </div>
            {% else %}
            <div class="log-reg-container">
              <button class="w98-button" id="index-login-btn">Login</button>
              <button class="w98-button" id="index-register-btn">
                Register
              </button>
            </div>
            {% endif %}
          </li>
        </ul>
      </div>
    </div>
    <div
      id="disable-bg-container"
      class="draggable-window small-window top-right disable-bg-container"
    >
      <div class="window-content">
        <div class="title-bar" id="disable-bg-title-bar">
          <h4>Background Control</h4>
          <button id="close-disable-bg-button" class="w98-button title-button">
            X
          </button>
        </div>
        <div style="padding: 15px">
          <p style="margin: 0 0 10px 0; font-size: 11px">
            Control the animated background:
          </p>
          <button id="toggle-bg-button" class="w98-button">
            Disable Background
          </button>
        </div>
      </div>
    </div>
    <script>
      // Set global constants
      const SHADERURL =
        "{{ url_for('static', filename='glsl/indexBGShader.glsl') }}";
      const OSRSENDPOINT = "{{ url_for('osrs.index') }}";
      const SUPERCOMBATSENDPOINT = "{{ url_for('osrs.super_combats') }}";
      const GOADINGREGENSENDPOINT = "{{ url_for('osrs.goading_regens') }}";
      const ITEMSEARCHENDPOINT = "{{ url_for('osrs.item_search') }}";
      // Set global variables
      window.openStates = {};
    </script>
    <script src="{{ url_for('static', filename='js/index_background.js') }}"></script>
    <script src="{{ url_for('static', filename='js/drag_window.js') }}"></script>
    <script src="{{ url_for('static', filename='js/window_manager.js') }}"></script>
    <script src="{{ url_for('static', filename='js/open_window.js') }}"></script>
    <script src="{{ url_for('static', filename='js/window_initializer.js') }}"></script>
    <script>
      function loadScript(url) {
        return new Promise((resolve, reject) => {
          const script = document.createElement("script");
          script.src = url;
          script.onload = () => resolve();
          script.onerror = () =>
            reject(new Error(`Failed to load script: ${url}`));
          document.head.appendChild(script);
        });
      }

      // Initialize modular window system
      document.addEventListener("DOMContentLoaded", function () {
        // Wait for windowManager to be ready before using it
        const initializeWindows = () => {
          // Ensure windowManager is available
          if (typeof windowManager === "undefined") {
            console.error(
              "windowManager is not defined. Check that window_manager.js is loaded correctly."
            );
            return;
          }

          windowManager.centerWindow("index_container");
          // Listen for window activation events
          document.addEventListener("windowActivated", function (e) {
            console.log(
              `Window activated: ${e.detail.windowId} with z-index ${e.detail.zIndex}`
            );
            console.log(
              "Current window order:",
              windowManager.getWindowZIndexOrder()
            );
          });
          setTimeout(() => {
            windowManager.setupWindowControls();
            windowManager.setupWindowButton(
              "#bg-control-button",
              "disable-bg-container"
            );
            console.log(
              "Initial window z-index order:",
              windowManager.getWindowZIndexOrder()
            );
          }, 100);

          initializeUI();
        };

        // Wait for windowManager to finish auto-discovery
        if (windowManager && windowManager.windows.size > 0) {
          // Already initialized
          initializeWindows();
        } else {
          // Wait for windowManager to be ready
          document.addEventListener("windowManagerReady", initializeWindows, {
            once: true,
          });
        }
      });

      function initializeUI() {
        // Get references to UI elements
        const toggleBgButton = document.getElementById("toggle-bg-button");
        const closeBgButton = document.getElementById("close-disable-bg-button");
        const bgControlButton = document.getElementById("bg-control-button");
        const osrsButton = document.getElementById("osrs-index-button");
        const showcaseButton = document.getElementById("showcase-button");
        const blogButton = document.getElementById("blog-button");
        const aboutMeButton = document.getElementById("about-me-button");
        const loginButton = document.getElementById("index-login-btn");
        const registerButton = document.getElementById("index-register-btn");
        const logoutButton = document.getElementById("index-logout-btn");

        // Background toggle functionality
        if (toggleBgButton) {
          toggleBgButton.addEventListener("click", function () {
            if (typeof backgroundWave !== "undefined" && backgroundWave) {
              const isEnabled = backgroundWave.toggle();
              toggleBgButton.textContent = isEnabled
                ? "Disable Background"
                : "Enable Background";
            }
          });
        }

        // Close background control window
        if (closeBgButton) {
          closeBgButton.addEventListener("click", function () {
            windowManager.hideWindow("disable-bg-container");
          });
        }

        if (loginButton) {
          // Set up login button with window manager
          const loginInstance = new window.WindowInitializer(
            windowManager,
            "loginContainer",
            "login-window",
            "login-container",
            "index-login-btn",
            "login-title-bar",
            "close-login-button",
            "{{ url_for('fort.login_modal') }}",
            true
          );

          loginButton.addEventListener("click", async function () {
            try {
              // The WindowInitializer stores the OpenWindow instance globally
              await window.loginContainerInstance.open();
            } catch (error) {
              console.error("Failed to open login window:", error);
              alert(
                "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAaaaargh! Something went wrong. Please try again later."
              );
            }
          });
        }
        

        if (registerButton) {
          // Set up register button with window manager
          const registerInstance = new window.WindowInitializer(
            windowManager,
            "registerContainer",
            "register-window",
            "register-container",
            "index-register-btn",
            "register-title-bar",
            "close-register-button",
            "{{ url_for('fort.register_modal') }}",
            true
          );

          registerButton.addEventListener("click", async function () {
            try {
              // The WindowInitializer stores the OpenWindow instance globally
              await window.registerContainerInstance.open();
            } catch (error) {
              console.error("Failed to open register window:", error);
              alert(
                "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAaaaargh! Something went wrong. Please try again later."
              );
            }
          });
        }

        // Handle logout button
        if (logoutButton) {
          logoutButton.addEventListener("click", async function () {
            try {
              const csrfToken = document
                .querySelector('meta[name="csrf-token"]')
                .getAttribute("content");
              const response = await fetch("{{ url_for('fort.logout') }}", {
                method: "POST",
                credentials: "include",
                headers: {
                  "Content-Type": "application/json",
                  "X-CSRFToken": csrfToken,
                },
              });

              const result = await response.json();

              if (result.status === "success") {
                console.log("Logout successful, reloading page");
                window.location.reload();
              } else {
                console.error("Logout failed:", result);
                alert("Logout failed. Please try again.");
              }
            } catch (error) {
              console.error("Logout error:", error);
              alert("Logout failed: " + error.message);
            }
          });
        }

        if (osrsButton) {
          osrsButton.addEventListener("mouseover", async () => {
            console.log("OSRS Tools button hovered, preloading osrs_index.js");
            if ("osrsIndex" in window) {
              console.log("Preventing multiple loads of osrs_index.js");
              return;
            }
            console.log("Loading osrs_index.js");
            await loadScript(
              "{{ url_for('static', filename='js/osrs_index.js') }}"
            );
            await window.osrsIndex.openWindow();
            osrsButton.addEventListener("click", async () => {
              console.log("osrsButton clicked, opening OSRS tools window");
              await window.osrsWindow.open();
            });
          });
        }

        if (showcaseButton) {
          const showcaseInstance = new window.WindowInitializer(
            windowManager,
            "showcaseWindow",
            "showcase-window",
            "showcase-container",
            "showcase-button",
            "showcase-title-bar",
            "close-showcase-button",
            "{{ url_for('showcase.showcase_modal') }}",
            true,
            "1200px",
            "900px",
          );
          showcaseButton.addEventListener("click", async function () {
            try {
              await window.showcaseWindowInstance.open();
            } catch (error) {
              console.error("Failed to open showcase window:", error);
              alert(
                "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAaaaargh! Something went wrong. Please try again later."
              );
            }
          });
        }
      }
    </script>
    <script>
      document
        .getElementById("help-me-button")
        .addEventListener("click", function () {
          alert("Help is on the way!");
        });
    </script>
    <script>
      let escapeWindowStack = []; // Stack to manage windows that can be closed with Escape key
      document.addEventListener("keydown", function (event) {
        if (event.key === "Escape" && escapeWindowStack.length > 0) {
          const topWindow = escapeWindowStack.pop();
          console.debug("Closing window on Escape key:", topWindow.id);
          topWindow.close();
        }
      });
    </script>
  </body>
</html>
